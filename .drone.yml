kind: pipeline
type: docker
name: default

steps:
  - name: deploy
    image: docker:dind
    secrets: [CI_DOCKER_LOGIN, CI_OPENFAAS_PASSWORD]
    commands:
      - apk add --no-cache git
      - if [ -f "./faas-cli" ] ; then cp ./faas-cli /usr/local/bin/faas-cli || 0 ; fi
      - if [ ! -f "/usr/local/bin/faas-cli" ] ; then apk add --no-cache curl git && curl -sSL cli.openfaas.com | sh && chmod +x /usr/local/bin/faas-cli && /usr/local/bin/faas-cli template pull && cp /usr/local/bin/faas-cli ./faas-cli ; fi
      # Login & Push Docker image to private repo
      - echo $CI_DOCKER_LOGIN
      - echo -n "$CI_DOCKER_LOGIN" | docker login -u uglpec --password-stdin registry.gitlab.com
      - echo -n $CI_DOCKER_LOGIN | docker login -u uglpec --password-stdin registry.gitlab.com
      - echo -n ${CI_DOCKER_LOGIN} | docker login -u uglpec --password-stdin registry.gitlab.com
      - echo -n "${CI_DOCKER_LOGIN}" | docker login -u uglpec --password-stdin registry.gitlab.com
      - echo -n "$OPENFAAS" | /usr/local/bin/faas-cli login --username admin --password-stdin
      # Deploy function from private repo
      - /usr/local/bin/faas-cli up -f ./config.yml -a
